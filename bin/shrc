#!/bin/sh

#
# shrc command

set -eu

all() {
  tmp="$(mktemp)"
  find . -type f -name .shrc -exec dirname "{}" \; > "${tmp}"
  while read -r dir; do
    (cd "${dir}" && install && clean)
  done
}

#######################################
# description
# Arguments:
#  None
#######################################
clean() {
  isshrc
  dangling-rm "${superproject}"
}

#######################################
# show usage
# Arguments:
#   1
#######################################
help() {
  test $# -gt 0 || return 0

  case "$1" in
    -h|--help|help) rc=0 ;;
    -*)
      >&2 echo "${0##*/}: $1: invalid option/argument"
      >&2 echo
      ;;
  esac

  >&2 cat <<EOF
usage: ${0##*/} <clean|install>
   or: ${0##*/} [-h|--help|help]

shrc command to installs bin, man and bash_completion.d, from the top \
of a repository into to shrc external directory: ${RC_EXTERNAL}"

Project must have an ".shrc" file at the top of the repository and the following directories:
- bash_completion.d
- bin
- share/man

Directories are symlinked for bin and man, while files for bash_completions.d.

No command is 'install'

Commands:
  all                           install and clean all projects that have a ".shrc" file starting from home
  clean                       removes dangling
  install                      relative links to shrc external
   -h, --help, help     display this help and exit.
EOF
  exit "${rc:-1}"
}


#######################################
# installs bin, man and bash_completion.d to shrc external directory
# Arguments:
#  None
#######################################
install() {
  _install() {
     test -d "$1" || return 0
     relative "$1" "$2"
  }

  isshrc

  _install "${superproject}/bin" "${SHRC_EXTERNAL_BIN}/${superproject##*/}"
  _install "${superproject}/share/man" "${SHRC_EXTERNAL_MAN}/${superproject##*/}"

  test -d "${superproject}/bash_completion.d" || return 0
  for file in "${superproject}/bash_completion.d"/*; do
    relative "${file}" "${SHRC_EXTERNAL_COMPLETION_D}/${file##*/}"
  done
}


#######################################
# checks if directory has an .shrc file
# Arguments:
#  None
#######################################
isshrc() { test -d "${superproject}/.shrc" || Error "${0##*/}:"  "${superproject} is not an shrc project" && exit 1; }

#######################################
# shrc main command function
# Arguments:
#  None
#######################################
main() {
  help "$@"

  function="install"

  superproject="$(superproject)"

  for arg; do
    case "${arg}" in
      all|clean|install) function="${arg}"
    esac
  done

  "${function}" "$@"
}

main "$@"

